<!DOCTYPE html>
<html lang="en">
<!-- FourBridge Research v5.0 - Single Pass: Knowledge + Multi-Search = $0.05 -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FourBridge v5</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root {
      --bg: #09090b; --card: #18181b; --border: #27272a;
      --text: #fafafa; --dim: #a1a1aa;
      --accent: #3b82f6; --success: #22c55e; --warning: #f59e0b; --error: #ef4444;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; min-height: 100vh; }
    .container { max-width: 900px; margin: 0 auto; }
    
    h1 { font-size: 18px; font-weight: 600; }
    .subtitle { color: var(--dim); font-size: 11px; margin-bottom: 16px; }
    
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px; }
    
    label { display: block; font-size: 10px; color: var(--dim); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    input { width: 100%; padding: 8px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 13px; }
    input:focus { outline: none; border-color: var(--accent); }
    
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border: none; border-radius: 4px; font-size: 12px; font-weight: 500; cursor: pointer; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover:not(:disabled) { background: #2563eb; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { background: var(--border); color: var(--text); }
    .btn-success { background: var(--success); color: white; }
    .btn-small { padding: 4px 8px; font-size: 11px; }
    
    .status { padding: 8px 12px; border-radius: 4px; margin-bottom: 10px; font-size: 12px; display: flex; align-items: center; gap: 8px; }
    .status.loading { background: rgba(59,130,246,0.1); border: 1px solid var(--accent); }
    .status.success { background: rgba(34,197,94,0.1); border: 1px solid var(--success); }
    .status.error { background: rgba(239,68,68,0.1); border: 1px solid var(--error); }
    
    .spinner { width: 12px; height: 12px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .cost { display: inline-block; padding: 2px 6px; background: rgba(34,197,94,0.15); color: var(--success); border-radius: 3px; font-size: 10px; font-family: monospace; }
    
    .search-row { display: flex; gap: 8px; margin-bottom: 12px; }
    .search-row input { flex: 1; }
    
    .api-row { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
    .api-row input { flex: 1; }
    .dot { width: 6px; height: 6px; border-radius: 50%; }
    .dot.on { background: var(--success); }
    .dot.off { background: var(--error); }
    
    /* Results */
    .firm-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.3); border-radius: 6px; margin-bottom: 12px; }
    .firm-bar h3 { font-size: 14px; }
    .firm-bar .meta { font-size: 11px; color: var(--dim); margin-top: 2px; }
    .firm-bar .badge { display: inline-block; padding: 1px 6px; background: rgba(59,130,246,0.2); color: var(--accent); border-radius: 3px; font-size: 10px; margin-right: 6px; }
    
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th { text-align: left; padding: 6px 8px; font-size: 10px; text-transform: uppercase; color: var(--dim); border-bottom: 1px solid var(--border); }
    td { padding: 2px 4px; border-bottom: 1px solid var(--border); }
    
    .edit-input { background: transparent; border: 1px solid transparent; padding: 6px; color: var(--text); font-size: 12px; width: 100%; border-radius: 3px; }
    .edit-input:hover { border-color: var(--border); }
    .edit-input:focus { outline: none; border-color: var(--accent); background: var(--bg); }
    
    .li-status { font-size: 11px; }
    .li-status.found { color: var(--success); }
    .li-status.missing { color: var(--warning); }
    
    .del-btn { background: none; border: none; color: #52525b; cursor: pointer; padding: 4px; font-size: 14px; }
    .del-btn:hover { color: var(--error); }
    
    .add-row { padding: 8px; color: var(--dim); cursor: pointer; font-size: 12px; border-radius: 4px; }
    .add-row:hover { background: rgba(255,255,255,0.03); }
    
    .actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
    
    .db-section { margin-top: 20px; }
    .db-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .db-header h2 { font-size: 13px; color: var(--dim); }
    
    .empty { text-align: center; padding: 20px; color: var(--dim); font-size: 12px; }
    
    .tip { font-size: 10px; color: var(--dim); margin-top: 6px; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    function App() {
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('fb5_key') || '');
      const [query, setQuery] = useState('');
      const [loading, setLoading] = useState(false);
      const [status, setStatus] = useState(null);
      const [cost, setCost] = useState(0);
      
      // Editable results
      const [firm, setFirm] = useState(null);
      const [people, setPeople] = useState([]);
      
      // Database
      const [db, setDb] = useState(() => {
        try { return JSON.parse(localStorage.getItem('fb5_db')) || { prospects: [] }; }
        catch { return { prospects: [] }; }
      });
      
      useEffect(() => { if(apiKey) localStorage.setItem('fb5_key', apiKey); }, [apiKey]);
      useEffect(() => { localStorage.setItem('fb5_db', JSON.stringify(db)); }, [db]);
      
      // ============================================================
      // THE MAGIC: Single call with knowledge + multiple searches
      // ============================================================
      const research = async () => {
        if (!apiKey || !query.trim()) return;
        
        setLoading(true);
        setStatus({ msg: 'Researching (knowledge + web searches)...', type: 'loading' });
        setFirm(null);
        setPeople([]);
        
        try {
          // ONE prompt that instructs Claude to:
          // 1. Use its knowledge first
          // 2. Execute multiple targeted web searches
          // 3. Find LinkedIn for everyone
          const prompt = `Research "${query}" completely. You have web search available.

STRATEGY - Execute these steps:

STEP 1: Use your training knowledge to identify:
- The firm's official name, type (SFO/MFO/RIA/Foundation/Endowment), location, AUM, website
- Key executives you already know

STEP 2: Web search for comprehensive leadership info:
- Search: "${query} leadership team executives"
- Search: "${query} management team about"
- Search: "site:theorg.com ${query}" (org chart database)

STEP 3: For EACH person found, search LinkedIn:
- Search: "site:linkedin.com/in [FirstName] [LastName] ${query}"
- Use their title/credentials to find the right profile
- Get the EXACT LinkedIn URL from search results

STEP 4: Compile EVERYONE into JSON.

Return this JSON structure:
{
  "firm": {
    "name": "Official Name",
    "type": "MFO/SFO/Foundation/etc",
    "location": "City, State",
    "aum": "$X billion or unknown",
    "website": "https://..."
  },
  "people": [
    {"name": "Gregory J. Fleming", "title": "President & CEO", "linkedin": "https://linkedin.com/in/actual-slug"},
    {"name": "Casey Clark, CFA", "title": "CIO", "linkedin": "https://linkedin.com/in/casey-clark-cfa-xxxxx"},
    {"name": "Person Without LinkedIn", "title": "CFO", "linkedin": null}
  ]
}

IMPORTANT:
- Include ALL leadership you find (aim for 5-15 people)
- LinkedIn URLs must be EXACT from search results (not guessed)
- Include credentials (CFA, CPA, MBA) in names when shown
- Return ONLY valid JSON`;

          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-api-key": apiKey,
              "anthropic-version": "2023-06-01",
              "anthropic-dangerous-direct-browser-access": "true",
              "anthropic-beta": "token-efficient-tools-2025-02-19"
            },
            body: JSON.stringify({
              model: "claude-3-5-haiku-20241022",
              max_tokens: 3000,
              tools: [{ type: "web_search_20250305", name: "web_search" }],
              messages: [{ role: "user", content: prompt }]
            })
          });
          
          if (!response.ok) throw new Error((await response.json()).error?.message || 'API Error');
          
          const data = await response.json();
          
          // Cost = tokens + $0.05 for web search invocation
          const tokenCost = (data.usage?.input_tokens || 0) * 0.00000025 + 
                           (data.usage?.output_tokens || 0) * 0.00000125;
          const totalCost = tokenCost + 0.05;
          setCost(totalCost);
          
          console.log(`=== SINGLE PASS: ${data.usage?.input_tokens}in / ${data.usage?.output_tokens}out = $${totalCost.toFixed(4)} ===`);
          
          // Extract text from response
          const text = data.content?.filter(c => c.type === 'text').map(c => c.text).join('\n') || '';
          console.log("=== RESPONSE ===\n", text);
          
          // Parse JSON
          const parsed = parseJSON(text);
          console.log("=== PARSED ===", parsed);
          
          if (parsed?.firm) {
            setFirm(parsed.firm);
            
            const ppl = (parsed.people || []).map((p, i) => ({
              id: `${Date.now()}_${i}`,
              name: p.name || '',
              title: p.title || '',
              linkedin: (p.linkedin && p.linkedin !== 'null' && p.linkedin.includes('linkedin.com')) ? p.linkedin : ''
            }));
            
            setPeople(ppl);
            
            const withLI = ppl.filter(p => p.linkedin).length;
            setStatus({ msg: `Found ${ppl.length} people, ${withLI} with LinkedIn`, type: 'success' });
          } else {
            setStatus({ msg: 'Could not parse results. Check console.', type: 'error' });
          }
          
        } catch (err) {
          console.error(err);
          setStatus({ msg: err.message, type: 'error' });
        } finally {
          setLoading(false);
        }
      };
      
      // JSON Parser
      const parseJSON = (text) => {
        let s = text.replace(/```json\s*/gi, '').replace(/```/g, '').trim();
        const start = s.indexOf('{');
        if (start === -1) return null;
        
        let depth = 0, inStr = false, esc = false, end = -1;
        for (let i = start; i < s.length; i++) {
          const c = s[i];
          if (esc) { esc = false; continue; }
          if (c === '\\') { esc = true; continue; }
          if (c === '"') { inStr = !inStr; continue; }
          if (!inStr) {
            if (c === '{') depth++;
            if (c === '}') { depth--; if (depth === 0) { end = i; break; } }
          }
        }
        if (end === -1) return null;
        
        let json = s.substring(start, end + 1);
        try { return JSON.parse(json); } catch {}
        
        // Repair
        json = json.replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
        try { return JSON.parse(json); } catch { return null; }
      };
      
      // Edit handlers
      const updatePerson = (id, field, value) => {
        setPeople(prev => prev.map(p => p.id === id ? { ...p, [field]: value } : p));
      };
      
      const deletePerson = (id) => {
        setPeople(prev => prev.filter(p => p.id !== id));
      };
      
      const addPerson = () => {
        setPeople(prev => [...prev, { id: `${Date.now()}`, name: '', title: '', linkedin: '' }]);
      };
      
      // Save to database
      const saveToDb = () => {
        if (!firm || people.length === 0) return;
        
        const newProspects = people
          .filter(p => p.name.trim())
          .map(p => ({
            id: p.id,
            name: p.name,
            title: p.title,
            firm: firm.name,
            linkedin: p.linkedin || null,
            addedAt: new Date().toISOString()
          }));
        
        // Dedupe by name+firm
        const existing = new Set(db.prospects.map(p => `${p.name}|${p.firm}`.toLowerCase()));
        const unique = newProspects.filter(p => !existing.has(`${p.name}|${p.firm}`.toLowerCase()));
        
        setDb(prev => ({ prospects: [...prev.prospects, ...unique] }));
        setStatus({ msg: `Saved ${unique.length} new prospects`, type: 'success' });
      };
      
      // Clear current
      const clearCurrent = () => {
        setFirm(null);
        setPeople([]);
        setQuery('');
        setCost(0);
        setStatus(null);
      };
      
      // Export
      const exportDb = () => {
        const blob = new Blob([JSON.stringify(db, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `fourbridge_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
      };
      
      return (
        <div className="container">
          <h1>üéØ FourBridge Research</h1>
          <p className="subtitle">v5.0 ‚Ä¢ Single pass: Claude knowledge + multi-search = <span className="cost">~$0.05</span></p>
          
          <div className="card">
            <div className="api-row">
              <span className={`dot ${apiKey ? 'on' : 'off'}`}></span>
              <input
                type="password"
                placeholder="Anthropic API Key"
                value={apiKey}
                onChange={e => setApiKey(e.target.value)}
              />
            </div>
            
            <div className="search-row">
              <input
                placeholder="Enter firm name: Rockefeller Capital, Sontag Foundation, Harris Family..."
                value={query}
                onChange={e => setQuery(e.target.value)}
                onKeyDown={e => e.key === 'Enter' && research()}
              />
              <button className="btn btn-primary" onClick={research} disabled={!apiKey || !query.trim() || loading}>
                {loading ? <><span className="spinner"></span> Working...</> : 'üîç Research'}
              </button>
            </div>
            
            <p className="tip">
              One API call searches everything: firm info, leadership team, org charts, and LinkedIn URLs for each person.
            </p>
          </div>
          
          {status && (
            <div className={`status ${status.type}`}>
              {status.type === 'loading' && <span className="spinner"></span>}
              {status.msg}
              {cost > 0 && <span className="cost" style={{marginLeft: 'auto'}}>${cost.toFixed(4)}</span>}
            </div>
          )}
          
          {firm && (
            <div className="card">
              <div className="firm-bar">
                <div>
                  <h3>{firm.name}</h3>
                  <div className="meta">
                    {firm.type && <span className="badge">{firm.type}</span>}
                    {firm.location}
                    {firm.aum && firm.aum !== 'unknown' && ` ‚Ä¢ ${firm.aum}`}
                  </div>
                </div>
                <button className="btn btn-small btn-secondary" onClick={clearCurrent}>‚úï Clear</button>
              </div>
              
              <table>
                <thead>
                  <tr>
                    <th style={{width: '25%'}}>Name</th>
                    <th style={{width: '25%'}}>Title</th>
                    <th style={{width: '40%'}}>LinkedIn</th>
                    <th style={{width: '10%'}}></th>
                  </tr>
                </thead>
                <tbody>
                  {people.map(p => (
                    <tr key={p.id}>
                      <td>
                        <input
                          className="edit-input"
                          value={p.name}
                          onChange={e => updatePerson(p.id, 'name', e.target.value)}
                          placeholder="Name"
                        />
                      </td>
                      <td>
                        <input
                          className="edit-input"
                          value={p.title}
                          onChange={e => updatePerson(p.id, 'title', e.target.value)}
                          placeholder="Title"
                        />
                      </td>
                      <td>
                        <input
                          className="edit-input"
                          value={p.linkedin}
                          onChange={e => updatePerson(p.id, 'linkedin', e.target.value)}
                          placeholder="https://linkedin.com/in/..."
                          style={{ color: p.linkedin ? 'var(--success)' : 'var(--dim)' }}
                        />
                      </td>
                      <td>
                        <button className="del-btn" onClick={() => deletePerson(p.id)}>√ó</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              
              <div className="add-row" onClick={addPerson}>+ Add person</div>
              
              <div className="actions">
                <button className="btn btn-success" onClick={saveToDb}>
                  üíæ Save {people.filter(p => p.name.trim()).length} to Database
                </button>
                <span style={{ marginLeft: 'auto', fontSize: 11, color: 'var(--dim)' }}>
                  {people.filter(p => p.linkedin).length}/{people.length} have LinkedIn
                </span>
              </div>
            </div>
          )}
          
          {/* Database */}
          <div className="db-section">
            <div className="db-header">
              <h2>üìÅ Database ({db.prospects.length} prospects)</h2>
              <div style={{ display: 'flex', gap: 8 }}>
                <button className="btn btn-small btn-secondary" onClick={exportDb}>Export</button>
                <button className="btn btn-small btn-secondary" onClick={() => {
                  if(confirm('Clear all?')) setDb({ prospects: [] });
                }}>Clear</button>
              </div>
            </div>
            
            {db.prospects.length > 0 ? (
              <div className="card" style={{ padding: 0 }}>
                <table>
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Title</th>
                      <th>Firm</th>
                      <th>LinkedIn</th>
                    </tr>
                  </thead>
                  <tbody>
                    {db.prospects.slice(-10).reverse().map(p => (
                      <tr key={p.id}>
                        <td style={{ padding: 8, fontWeight: 500 }}>{p.name}</td>
                        <td style={{ padding: 8, color: 'var(--dim)' }}>{p.title}</td>
                        <td style={{ padding: 8 }}>{p.firm}</td>
                        <td style={{ padding: 8 }}>
                          {p.linkedin ? (
                            <a href={p.linkedin} target="_blank" style={{ color: 'var(--accent)', fontSize: 11 }}>View ‚Üí</a>
                          ) : '‚Äî'}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            ) : (
              <div className="card empty">No prospects saved yet</div>
            )}
          </div>
        </div>
      );
    }
    
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
