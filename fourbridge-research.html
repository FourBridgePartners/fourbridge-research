<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FourBridge Research Tool</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
// ============================================================
// MULTI-PASS DISCOVERY PROMPTS
// ============================================================
const PROMPTS = {
  discovery: (firm, location) => `You are a research analyst investigating a private investment firm.

FIRM: "${firm}"
LOCATION: ${location || 'Unknown'}

YOUR TASK: Gather initial intelligence. Search broadly and report EVERYTHING you find.

SEARCH APPROACH:
- Start with the firm name + location
- Look for their website, LinkedIn company page
- Look for news mentions, conference appearances
- Look for any people mentioned in connection with the firm

REPORT AS JSON:
{
  "firmInfo": {
    "officialName": "exact name if found",
    "website": "URL if found",
    "linkedinCompany": "company page URL if found", 
    "description": "what they do",
    "type": "SFO/MFO/Foundation/Endowment/Unknown",
    "aum": "if mentioned"
  },
  "peopleHints": [
    {"name": "any name found", "context": "where you found them", "possibleTitle": "if mentioned", "linkedinUrl": "if found"}
  ],
  "usefulSources": [{"url": "URL worth exploring", "why": "what we might find"}],
  "searchesPerformed": ["list of searches"],
  "nextSteps": ["what to search next"]
}`,

  extraction: (firm, location, discovery) => `Continue research on "${firm}" (${location || 'Unknown location'}).

PASS 1 FINDINGS:
${JSON.stringify(discovery, null, 2)}

YOUR TASK: Find SPECIFIC PEOPLE who work there using what we learned.

STRATEGY:
${discovery?.firmInfo?.website ? `- Found website ${discovery.firmInfo.website} - search for team/about/people page` : '- No website found - search LinkedIn directly'}
${discovery?.peopleHints?.length > 0 ? `- People hints: ${discovery.peopleHints.map(p => p.name).join(', ')} - find their LinkedIn profiles` : '- No people hints - search: site:linkedin.com/in "${firm}"'}
${discovery?.usefulSources?.length > 0 ? `- Sources to explore: ${discovery.usefulSources.map(s => s.url).join(', ')}` : ''}

REPORT AS JSON:
{
  "verifiedPeople": [
    {"name": "Full Name", "title": "Title", "linkedin": "URL or null", "confidence": "high/medium/low", "source": "where verified"}
  ],
  "unverifiedHints": [{"name": "name", "reason": "why not verified"}],
  "additionalFindings": "new info about firm"
}

CRITICAL: Only include people you found EVIDENCE for. Quality over quantity.`,

  enrichment: (firm, people, gaps) => `Complete research on "${firm}".

PEOPLE FOUND:
${JSON.stringify(people, null, 2)}

GAPS: ${gaps}

YOUR TASK: 
1. Find LinkedIn URLs for people missing them
2. Find titles for people missing them  
3. Search for additional team members

SEARCH IDEAS:
${people.filter(p => !p.linkedin).map(p => `- "${p.name}" "${firm}" LinkedIn`).join('\n') || '- All have LinkedIn'}
- "${firm}" + other titles (Partner, Director, VP)
- Conference/speaker appearances

REPORT AS JSON:
{
  "enrichedPeople": [{"name": "...", "title": "...", "linkedin": "...", "confidence": "...", "source": "..."}],
  "newPeopleFound": [{"name": "...", "title": "...", "linkedin": "...", "confidence": "...", "source": "..."}]
}`,

  validation: (firm, people) => `Final verification for "${firm}" contacts.

CANDIDATES:
${JSON.stringify(people, null, 2)}

VERIFY each person CURRENTLY works at "${firm}":
- Check LinkedIn shows this as current employer
- Look for recent (2024-2025) mentions
- Remove anyone who has left

REPORT AS JSON:
{
  "verified": [{"name": "...", "title": "...", "linkedin": "...", "confidence": "high/medium", "verificationSource": "..."}],
  "removed": [{"name": "...", "reason": "..."}]
}`
};

// ============================================================
// MAIN COMPONENT
// ============================================================
function FourBridgeResearch() {
  const [apiKey, setApiKey] = React.useState('');
  const [apiConfigured, setApiConfigured] = React.useState(false);
  const [firmName, setFirmName] = React.useState('');
  const [location, setLocation] = React.useState('');
  const [stage, setStage] = React.useState(1);
  const [loading, setLoading] = React.useState(false);
  const [currentPass, setCurrentPass] = React.useState('');
  const [error, setError] = React.useState('');
  const [debugLog, setDebugLog] = React.useState([]);
  const [firmOptions, setFirmOptions] = React.useState([]);
  const [firm, setFirm] = React.useState(null);
  const [contacts, setContacts] = React.useState([]);
  const [database, setDatabase] = React.useState([]);
  const [newName, setNewName] = React.useState('');
  const [newLinkedIn, setNewLinkedIn] = React.useState('');
  const [passResults, setPassResults] = React.useState([]);
  const abortRef = React.useRef(false);

  const log = React.useCallback((message, type = 'info') => {
    const time = new Date().toLocaleTimeString();
    setDebugLog(prev => [...prev.slice(-30), { time, message, type }]);
  }, []);

  const callClaudeAPI = async (prompt, passName = 'API Call') => {
    if (!apiKey) throw new Error('API key not configured');
    if (abortRef.current) throw new Error('Aborted');
    
    log(`${passName}: Calling Claude...`, 'info');
    setCurrentPass(passName);
    
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-3-5-haiku-20241022',
        max_tokens: 4096,
        tools: [{ type: 'web_search_20250305', name: 'web_search' }],
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!response.ok) {
      log(`${passName}: Failed - ${response.status}`, 'error');
      throw new Error(`API Error: ${response.status}`);
    }

    const data = await response.json();
    const text = data.content?.filter(b => b.type === 'text')?.map(b => b.text)?.join('\n') || '';
    log(`${passName}: Complete (${text.length} chars)`, 'success');
    return text;
  };

  const parseJSON = (text) => {
    const match = text.match(/\{[\s\S]*\}/);
    if (match) {
      try {
        return JSON.parse(match[0]);
      } catch {
        const fixed = match[0].replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
        try { return JSON.parse(fixed); } catch { return null; }
      }
    }
    return null;
  };

  const parseJSONArray = (text) => {
    // Strip markdown code blocks if present
    let cleaned = text.replace(/```json\s*/gi, '').replace(/```\s*/g, '');
    
    const match = cleaned.match(/\[[\s\S]*\]/);
    if (match) {
      try { 
        return JSON.parse(match[0]); 
      } catch {
        // Try fixing common issues
        const fixed = match[0]
          .replace(/,\s*]/g, ']')           // Remove trailing commas in arrays
          .replace(/,\s*}/g, '}')           // Remove trailing commas in objects
          .replace(/'/g, '"')               // Replace single quotes with double
          .replace(/(\w+):/g, '"$1":');     // Quote unquoted keys
        try { return JSON.parse(fixed); } catch { return null; }
      }
    }
    
    // Fallback: try to find individual objects and make an array
    const objectMatch = cleaned.match(/\{[\s\S]*?\}/g);
    if (objectMatch && objectMatch.length > 0) {
      try {
        return objectMatch.map(o => JSON.parse(o)).filter(Boolean);
      } catch { return null; }
    }
    
    return null;
  };

  // Multi-pass discovery
  const runDiscovery = async (selectedFirm) => {
    setLoading(true);
    setError('');
    setContacts([]);
    setPassResults([]);
    abortRef.current = false;
    
    const firmNameToSearch = selectedFirm.name;
    const locationToSearch = selectedFirm.location || location;
    
    log(`Starting multi-pass discovery for: ${firmNameToSearch}`, 'info');
    
    try {
      // PASS 1: DISCOVERY
      setCurrentPass('Pass 1: Discovery - Gathering intelligence...');
      const pass1Response = await callClaudeAPI(
        PROMPTS.discovery(firmNameToSearch, locationToSearch),
        'Pass 1: Discovery'
      );
      const pass1Data = parseJSON(pass1Response);
      setPassResults(prev => [...prev, { name: 'Discovery', data: pass1Data }]);
      
      if (pass1Data?.firmInfo) {
        setFirm(prev => ({ ...prev, ...pass1Data.firmInfo }));
      }

      // PASS 2: EXTRACTION
      if (abortRef.current) throw new Error('Aborted');
      setCurrentPass('Pass 2: Extraction - Finding specific people...');
      
      const pass2Response = await callClaudeAPI(
        PROMPTS.extraction(firmNameToSearch, locationToSearch, pass1Data || {}),
        'Pass 2: Extraction'
      );
      const pass2Data = parseJSON(pass2Response);
      setPassResults(prev => [...prev, { name: 'Extraction', data: pass2Data }]);

      let allPeople = pass2Data?.verifiedPeople || [];
      log(`Pass 2 found ${allPeople.length} verified people`, allPeople.length > 0 ? 'success' : 'info');

      // PASS 3: ENRICHMENT (if needed)
      const needsEnrichment = allPeople.length < 3 || allPeople.some(p => !p.linkedin);
      
      if (needsEnrichment && !abortRef.current) {
        setCurrentPass('Pass 3: Enrichment - Filling gaps...');
        
        const gaps = allPeople.length < 3 
          ? `Only ${allPeople.length} people found, need more` 
          : 'Some people missing LinkedIn URLs';
        
        const pass3Response = await callClaudeAPI(
          PROMPTS.enrichment(firmNameToSearch, allPeople, gaps),
          'Pass 3: Enrichment'
        );
        const pass3Data = parseJSON(pass3Response);
        setPassResults(prev => [...prev, { name: 'Enrichment', data: pass3Data }]);

        if (pass3Data?.enrichedPeople) {
          allPeople = pass3Data.enrichedPeople;
        }
        if (pass3Data?.newPeopleFound) {
          allPeople = [...allPeople, ...pass3Data.newPeopleFound];
        }
        log(`After enrichment: ${allPeople.length} total people`, 'success');
      }

      // PASS 4: VALIDATION
      if (allPeople.length > 0 && !abortRef.current) {
        setCurrentPass('Pass 4: Validation - Verifying current employment...');
        
        const pass4Response = await callClaudeAPI(
          PROMPTS.validation(firmNameToSearch, allPeople),
          'Pass 4: Validation'
        );
        const pass4Data = parseJSON(pass4Response);
        setPassResults(prev => [...prev, { name: 'Validation', data: pass4Data }]);

        if (pass4Data?.verified) {
          allPeople = pass4Data.verified;
          log(`Validation complete: ${allPeople.length} verified contacts`, 'success');
        }
      }

      // Deduplicate and format
      const seen = new Set();
      const dedupedPeople = allPeople.filter(p => {
        const key = p.name?.toLowerCase();
        if (!key || seen.has(key)) return false;
        seen.add(key);
        return true;
      });

      const formattedContacts = dedupedPeople.map((p, i) => ({
        id: `c${Date.now()}_${i}`,
        name: p.name,
        title: p.title || 'Unknown',
        linkedin: p.linkedin || null,
        confidence: p.confidence || 'medium',
        source: p.source || p.verificationSource || 'Discovery',
        selected: !!p.linkedin,
        firm: firmNameToSearch
      }));

      setContacts(formattedContacts);
      setStage(2);
      log(`Discovery complete: ${formattedContacts.length} contacts found`, 'success');

    } catch (err) {
      if (err.message !== 'Aborted') {
        log(`Discovery failed: ${err.message}`, 'error');
        setError(err.message);
      }
    } finally {
      setLoading(false);
      setCurrentPass('');
    }
  };

  const searchFirm = async () => {
    if (!firmName.trim()) return;
    setLoading(true);
    setCurrentPass('Finding matching firms...');
    setError('');
    setFirmOptions([]);
    log(`Searching for: ${firmName}`, 'info');

    try {
      const prompt = `Search for "${firmName}"${location ? ` in ${location}` : ''} - find ALL matching investment firms, family offices, foundations, or endowments.

Return ONLY a valid JSON array (no markdown, no explanation, no code blocks):
[{"name":"Official Name","type":"SFO/MFO/Foundation/Endowment/RIA","location":"City, State","aum":"$X billion","description":"Brief description","confidence":"high/medium/low"}]

Rules:
- Return ONLY the JSON array, nothing else
- No markdown formatting or code blocks
- Include up to 5 different matching organizations
- If unsure about type, use best guess based on search results`;

      const response = await callClaudeAPI(prompt, 'Firm Search');
      log(`Raw response preview: ${response.substring(0, 200)}...`, 'info');
      const firms = parseJSONArray(response);
      
      if (firms && firms.length > 0) {
        log(`Found ${firms.length} matching firms`, 'success');
        
        if (firms.length === 1) {
          setFirm(firms[0]);
          setFirmOptions([]);
          setStage(2);
          await runDiscovery(firms[0]);
        } else {
          setFirmOptions(firms);
          setStage(1.5);
          setLoading(false);
        }
      } else {
        throw new Error('No matching firms found');
      }
    } catch (err) {
      log(`Firm search failed: ${err.message}`, 'error');
      setError(err.message);
      setLoading(false);
    }
  };

  const selectFirm = async (selectedFirm) => {
    setFirm(selectedFirm);
    setFirmOptions([]);
    log(`Selected: ${selectedFirm.name}`, 'success');
    await runDiscovery(selectedFirm);
  };

  const stopDiscovery = () => {
    abortRef.current = true;
    log('Discovery stopped by user', 'info');
  };

  const testApiKey = async () => {
    if (!apiKey.trim()) { setError('Please enter API key'); return; }
    setLoading(true);
    setError('');
    log(`Testing API key...`, 'info');

    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-3-5-haiku-20241022',
          max_tokens: 50,
          messages: [{ role: 'user', content: 'Reply with only: OK' }]
        })
      });

      if (response.ok) {
        log('API Connected!', 'success');
        setApiConfigured(true);
        // Save to localStorage
        try { localStorage.setItem('fourbridge_api_key', apiKey); } catch {}
      } else {
        throw new Error(`${response.status}`);
      }
    } catch (err) {
      log(`Connection failed: ${err.message}`, 'error');
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const deepSearch = async () => {
    if (!firm) return;
    setLoading(true);
    setCurrentPass('Deep Search: Looking for additional contacts...');
    log('Running deep search...', 'info');

    try {
      const existingNames = contacts.map(c => c.name).join(', ');
      
      const prompt = `Search for MORE people at "${firm.name || firm.officialName}" who are NOT these people: ${existingNames || 'none found yet'}.

Look for:
- Other executives, directors, VPs not yet found
- People in LinkedIn "People also viewed" 
- Conference speakers from this firm
- Board members or advisors

Return JSON:
{
  "newPeople": [
    {"name": "Full Name", "title": "Title", "linkedin": "URL or null", "confidence": "high/medium/low", "source": "where found"}
  ]
}

ONLY include people NOT in the existing list. Quality over quantity.`;

      const response = await callClaudeAPI(prompt, 'Deep Search');
      const data = parseJSON(response);
      
      if (data?.newPeople?.length > 0) {
        const existingNamesLower = contacts.map(c => c.name.toLowerCase());
        const newContacts = data.newPeople
          .filter(p => !existingNamesLower.includes(p.name.toLowerCase()))
          .map((c, i) => ({
            id: `c${Date.now()}_${i}`,
            name: c.name,
            title: c.title || 'Unknown',
            linkedin: c.linkedin || null,
            confidence: c.confidence || 'medium',
            source: c.source || 'Deep Search',
            selected: !!c.linkedin,
            firm: firm.name || firm.officialName
          }));
        
        setContacts(prev => [...prev, ...newContacts]);
        log(`Deep search found ${newContacts.length} new contacts`, 'success');
      } else {
        log('No additional contacts found', 'info');
      }
    } catch (err) {
      log(`Deep search failed: ${err.message}`, 'error');
    } finally {
      setLoading(false);
      setCurrentPass('');
    }
  };

  const toggleContact = (id) => setContacts(prev => prev.map(c => c.id === id ? { ...c, selected: !c.selected } : c));
  const updateContact = (id, field, value) => setContacts(prev => prev.map(c => c.id === id ? { ...c, [field]: value } : c));
  const removeContact = (id) => setContacts(prev => prev.filter(c => c.id !== id));

  const addManual = () => {
    if (!newName.trim()) return;
    setContacts(prev => [...prev, { 
      id: `c${Date.now()}`, 
      name: newName, 
      title: '', 
      linkedin: newLinkedIn || null, 
      confidence: 'manual',
      source: 'Manual entry',
      selected: !!newLinkedIn, 
      firm: firm?.name || firm?.officialName 
    }]);
    setNewName('');
    setNewLinkedIn('');
    log(`Added: ${newName}`, 'success');
  };

  const addToDatabase = () => {
    const selected = contacts.filter(c => c.selected);
    if (!selected.length) { setError('Select at least one contact'); return; }
    
    setDatabase(prev => [...prev, { 
      id: `e${Date.now()}`, 
      firm: { ...firm }, 
      contacts: selected, 
      addedAt: new Date().toISOString() 
    }]);
    log(`Added ${firm.name || firm.officialName} with ${selected.length} contacts`, 'success');
    
    resetState();
  };

  const resetState = () => {
    setStage(1);
    setFirm(null);
    setContacts([]);
    setFirmName('');
    setLocation('');
    setFirmOptions([]);
    setPassResults([]);
    setError('');
  };

  const [sheetsUrl, setSheetsUrl] = React.useState('');
  const [sheetsConfigured, setSheetsConfigured] = React.useState(false);

  // Load saved Sheets URL on mount
  React.useEffect(() => {
    try {
      const savedUrl = localStorage.getItem('fourbridge_sheets_url');
      if (savedUrl) {
        setSheetsUrl(savedUrl);
        setSheetsConfigured(true);
      }
    } catch {}
  }, []);

  const saveSheetsUrl = () => {
    if (sheetsUrl.includes('script.google.com')) {
      localStorage.setItem('fourbridge_sheets_url', sheetsUrl);
      setSheetsConfigured(true);
      log('Google Sheets URL saved', 'success');
    } else {
      setError('Invalid Apps Script URL');
    }
  };

  const pushToSheets = async () => {
    if (!sheetsUrl || database.length === 0) return;
    
    setLoading(true);
    log('Pushing to Google Sheets...', 'info');
    
    try {
      const data = {
        exportedAt: new Date().toISOString(),
        firms: database.map(d => d.firm),
        prospects: database.flatMap(d => d.contacts)
      };
      
      const response = await fetch(sheetsUrl, {
        method: 'POST',
        mode: 'no-cors', // Required for Apps Script
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      // no-cors means we can't read response, but if no error, assume success
      log(`Pushed ${data.firms.length} firms and ${data.prospects.length} prospects to Sheets`, 'success');
      alert(`‚úÖ Pushed to Google Sheets!\n\n${data.firms.length} firm(s)\n${data.prospects.length} prospect(s)`);
      
    } catch (err) {
      log(`Push failed: ${err.message}`, 'error');
      setError(`Failed to push to Sheets: ${err.message}`);
    } finally {
      setLoading(false);
    }
  };

  const exportDB = () => {
    const data = {
      exportedAt: new Date().toISOString(),
      firms: database.map(d => d.firm),
      prospects: database.flatMap(d => d.contacts)
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `fourbridge_research_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
  };

  // Load saved API key on mount
  React.useEffect(() => {
    try {
      const saved = localStorage.getItem('fourbridge_api_key');
      if (saved) {
        setApiKey(saved);
        setApiConfigured(true);
        log('Loaded saved API key', 'info');
      }
    } catch {}
  }, []);

  const selectedCount = contacts.filter(c => c.selected && c.linkedin).length;

  return (
    <div className="max-w-3xl mx-auto font-sans">
      {/* Header */}
      <div className="bg-white/10 backdrop-blur text-white p-6 rounded-t-xl text-center">
        <h1 className="text-2xl font-bold">üîç FourBridge Research</h1>
        <p className="text-sm opacity-90 mt-1">Multi-Pass Intelligent Discovery</p>
      </div>

      <div className="bg-white border-2 border-t-0 border-gray-200 rounded-b-xl p-6">
        
        {/* API Key Config */}
        {!apiConfigured && (
          <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
            <div className="font-bold text-yellow-800 mb-2">‚öôÔ∏è Enter Anthropic API Key</div>
            <div className="flex gap-2">
              <input
                type="password"
                placeholder="sk-ant-api03-..."
                value={apiKey}
                onChange={(e) => setApiKey(e.target.value)}
                className="flex-1 p-3 border-2 border-gray-300 rounded-lg text-sm"
              />
              <button 
                onClick={testApiKey} 
                disabled={loading}
                className="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold disabled:opacity-50"
              >
                {loading ? '...' : 'Connect'}
              </button>
            </div>
            <p className="text-xs text-yellow-700 mt-2">Your key is stored locally in your browser only.</p>
          </div>
        )}

        {apiConfigured && (
          <div className="bg-green-50 border-2 border-green-400 rounded-lg p-3 mb-4 flex justify-between items-center">
            <span className="text-green-800 font-semibold">‚úÖ API Connected</span>
            <button 
              onClick={() => { setApiConfigured(false); setApiKey(''); localStorage.removeItem('fourbridge_api_key'); }}
              className="text-sm text-green-700 hover:text-green-900"
            >
              Change Key
            </button>
          </div>
        )}

        {/* Google Sheets Config */}
        {apiConfigured && !sheetsConfigured && (
          <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-4">
            <div className="font-bold text-blue-800 mb-2">üìä Connect to Google Sheets (Optional)</div>
            <p className="text-xs text-blue-600 mb-2">Paste your Apps Script Web App URL to push research directly to your sheet.</p>
            <div className="flex gap-2">
              <input
                type="text"
                placeholder="https://script.google.com/macros/s/.../exec"
                value={sheetsUrl}
                onChange={(e) => setSheetsUrl(e.target.value)}
                className="flex-1 p-2 border-2 border-gray-300 rounded-lg text-sm"
              />
              <button 
                onClick={saveSheetsUrl}
                className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold text-sm"
              >
                Save
              </button>
            </div>
          </div>
        )}

        {sheetsConfigured && (
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-2 mb-4 flex justify-between items-center text-sm">
            <span className="text-blue-800">üìä Google Sheets connected</span>
            <button 
              onClick={() => { setSheetsConfigured(false); setSheetsUrl(''); localStorage.removeItem('fourbridge_sheets_url'); }}
              className="text-blue-600 hover:text-blue-800"
            >
              Disconnect
            </button>
          </div>
        )}

        {error && (
          <div className="bg-red-50 border-2 border-red-300 text-red-800 p-3 rounded-lg mb-4">
            ‚ùå {error}
          </div>
        )}

        {/* Stage 1: Firm Search */}
        {stage === 1 && apiConfigured && (
          <>
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
              <div className="font-bold text-blue-800 uppercase text-sm tracking-wide">Stage 1 ‚Üí Firm Search</div>
              <div className="text-blue-600 text-sm">Search for family offices, foundations, endowments</div>
            </div>
            
            <input
              placeholder="Firm name (e.g., Rockefeller Capital Management)"
              value={firmName}
              onChange={(e) => setFirmName(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && searchFirm()}
              className="w-full p-3 border-2 border-gray-300 rounded-lg mb-3 text-base"
            />
            <input
              placeholder="Location (optional)"
              value={location}
              onChange={(e) => setLocation(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && searchFirm()}
              className="w-full p-3 border-2 border-gray-300 rounded-lg mb-3"
            />
            <button 
              onClick={searchFirm} 
              disabled={loading}
              className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white py-3 rounded-lg font-semibold disabled:opacity-50"
            >
              {loading ? currentPass || 'Searching...' : 'Search ‚Üí'}
            </button>
          </>
        )}

        {/* Stage 1.5: Firm Selection */}
        {stage === 1.5 && (
          <>
            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
              <div className="font-bold text-amber-800 uppercase text-sm tracking-wide">Select the Right Firm</div>
              <div className="text-amber-600 text-sm">Found {firmOptions.length} organizations matching "{firmName}"</div>
            </div>

            <div className="space-y-3">
              {firmOptions.map((f, idx) => (
                <div
                  key={idx}
                  onClick={() => selectFirm(f)}
                  className="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-purple-400 hover:shadow-md transition-all bg-white group"
                >
                  <div className="flex items-start justify-between gap-4">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1 flex-wrap">
                        <span className="font-bold text-gray-800 text-lg group-hover:text-purple-700">{f.name}</span>
                        <span className={`text-xs px-2 py-1 rounded-full font-bold uppercase ${
                          f.type === 'SFO' ? 'bg-blue-100 text-blue-800' :
                          f.type === 'MFO' ? 'bg-yellow-100 text-yellow-800' :
                          f.type === 'Foundation' ? 'bg-green-100 text-green-800' :
                          f.type === 'Endowment' ? 'bg-purple-100 text-purple-800' :
                          'bg-gray-100 text-gray-800'
                        }`}>
                          {f.type}
                        </span>
                      </div>
                      <div className="text-gray-500 text-sm mb-2">
                        üìç {f.location} ‚Ä¢ üí∞ {f.aum}
                      </div>
                      <div className="text-gray-600 text-sm">{f.description}</div>
                    </div>
                    <span className="text-purple-600 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity">
                      Select ‚Üí
                    </span>
                  </div>
                </div>
              ))}
            </div>

            <button 
              onClick={resetState}
              className="mt-4 px-4 py-2 border-2 border-gray-300 rounded-lg font-medium hover:bg-gray-50 text-gray-600"
            >
              ‚Üê Search Again
            </button>
          </>
        )}

        {/* Stage 2: Discovery Results */}
        {stage === 2 && (
          <>
            <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
              <div className="font-bold text-green-800 uppercase text-sm tracking-wide">Stage 2 ‚Üí Discovery Results</div>
              <div className="text-green-600 text-sm">
                {loading ? currentPass : `Found ${contacts.length} contacts at ${firm?.name || firm?.officialName}`}
              </div>
            </div>

            {/* Firm Info */}
            {firm && (
              <div className="border-2 border-gray-200 rounded-lg p-4 mb-4">
                <div className="flex items-start gap-4">
                  <div className="text-3xl">üè¢</div>
                  <div className="flex-1">
                    <div className="font-bold text-lg text-gray-800">{firm.name || firm.officialName}</div>
                    <div className="text-gray-500 text-sm">
                      {firm.type} | {firm.location} | {firm.aum || 'AUM Unknown'}
                    </div>
                    {firm.description && (
                      <div className="text-gray-600 text-sm mt-1">{firm.description}</div>
                    )}
                  </div>
                  <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase ${
                    firm.type === 'SFO' ? 'bg-blue-100 text-blue-800' :
                    firm.type === 'MFO' ? 'bg-yellow-100 text-yellow-800' :
                    firm.type === 'Foundation' ? 'bg-green-100 text-green-800' :
                    'bg-gray-100 text-gray-800'
                  }`}>
                    {firm.type || 'Unknown'}
                  </span>
                </div>
              </div>
            )}

            {/* Loading State with Pass Progress */}
            {loading ? (
              <div className="bg-gray-50 border-2 border-gray-200 rounded-lg p-8">
                <div className="flex items-center justify-center gap-4 mb-6">
                  <div className="animate-spin w-8 h-8 border-4 border-purple-200 border-t-purple-600 rounded-full"></div>
                  <div className="text-gray-700 font-semibold">{currentPass}</div>
                </div>
                
                <div className="flex justify-center gap-2 mb-6">
                  {['Discovery', 'Extraction', 'Enrichment', 'Validation'].map((pass, i) => {
                    const completed = passResults.find(p => p.name === pass);
                    const isCurrent = currentPass.includes(pass) || currentPass.includes(`Pass ${i+1}`);
                    return (
                      <div key={pass} className="flex flex-col items-center">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold transition-all ${
                          completed ? 'bg-green-500 text-white' :
                          isCurrent ? 'bg-purple-500 text-white animate-pulse' :
                          'bg-gray-200 text-gray-500'
                        }`}>
                          {completed ? '‚úì' : i + 1}
                        </div>
                        <div className={`text-xs mt-1 ${isCurrent ? 'text-purple-600 font-semibold' : 'text-gray-500'}`}>
                          {pass}
                        </div>
                      </div>
                    );
                  })}
                </div>

                <button 
                  onClick={stopDiscovery}
                  className="mx-auto block text-sm text-red-600 hover:text-red-800 font-medium"
                >
                  ‚úï Stop Discovery
                </button>
              </div>
            ) : (
              <>
                {/* Team Header */}
                <div className="flex justify-between items-center mb-4">
                  <span className="font-semibold text-gray-700">üë• Team Members ({contacts.length})</span>
                  <button 
                    onClick={deepSearch}
                    disabled={loading}
                    className="text-sm bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-lg font-medium disabled:opacity-50"
                  >
                    üîç Deep Search for More
                  </button>
                </div>

                {/* Contact Cards */}
                {contacts.length === 0 ? (
                  <div className="text-center py-8 text-gray-500">
                    No contacts found. Try Deep Search or add manually.
                  </div>
                ) : (
                  contacts.map(c => (
                    <div 
                      key={c.id} 
                      className={`border-2 rounded-lg p-4 mb-3 transition-all ${
                        c.selected ? 'border-green-400 bg-green-50' : 'border-gray-200 bg-white'
                      }`}
                    >
                      <div className="flex items-start gap-3">
                        <input 
                          type="checkbox" 
                          checked={c.selected} 
                          onChange={() => toggleContact(c.id)} 
                          className="mt-1 w-5 h-5 accent-green-500 cursor-pointer" 
                        />
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 flex-wrap">
                            <input 
                              value={c.name} 
                              onChange={(e) => updateContact(c.id, 'name', e.target.value)} 
                              className="font-bold text-gray-800 border-none p-0 bg-transparent focus:outline-none"
                            />
                            <span className={`text-xs px-2 py-0.5 rounded font-medium ${
                              c.confidence === 'high' ? 'bg-green-100 text-green-700' :
                              c.confidence === 'medium' ? 'bg-yellow-100 text-yellow-700' :
                              c.confidence === 'manual' ? 'bg-blue-100 text-blue-700' :
                              'bg-red-100 text-red-700'
                            }`}>
                              {c.confidence}
                            </span>
                          </div>
                          <input 
                            value={c.title || ''} 
                            onChange={(e) => updateContact(c.id, 'title', e.target.value)} 
                            placeholder="Job title"
                            className="text-gray-500 text-sm w-full border-none p-0 bg-transparent mt-1 focus:outline-none"
                          />
                          {c.linkedin ? (
                            <a href={c.linkedin} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline text-sm mt-1 block truncate">
                              üîó {c.linkedin}
                            </a>
                          ) : (
                            <span className="inline-block mt-2 text-yellow-700 text-xs bg-yellow-100 px-2 py-1 rounded font-medium">
                              NO LINKEDIN
                            </span>
                          )}
                          {c.source && (
                            <div className="text-xs text-gray-400 mt-1">Source: {c.source}</div>
                          )}
                        </div>
                        <button 
                          onClick={() => removeContact(c.id)} 
                          className="text-red-400 hover:text-red-600 text-xl font-bold"
                        >
                          √ó
                        </button>
                      </div>
                    </div>
                  ))
                )}

                {/* Add Manual */}
                <div className="bg-gray-50 rounded-lg p-4 mb-4 border-2 border-dashed border-gray-300">
                  <div className="font-semibold mb-3 text-sm text-gray-600">+ Add Manually</div>
                  <div className="flex gap-2 flex-wrap">
                    <input 
                      placeholder="Name" 
                      value={newName} 
                      onChange={(e) => setNewName(e.target.value)} 
                      className="flex-1 min-w-32 p-2 border-2 border-gray-300 rounded-lg text-sm"
                    />
                    <input 
                      placeholder="LinkedIn URL (optional)" 
                      value={newLinkedIn} 
                      onChange={(e) => setNewLinkedIn(e.target.value)} 
                      className="flex-1 min-w-48 p-2 border-2 border-gray-300 rounded-lg text-sm"
                    />
                    <button 
                      onClick={addManual}
                      className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium text-sm"
                    >
                      Add
                    </button>
                  </div>
                </div>

                {/* Footer Actions */}
                <div className="flex justify-between items-center pt-4 border-t-2 border-gray-200 mt-4">
                  <span className="text-green-600 font-semibold">
                    ‚úì {selectedCount} contacts selected
                  </span>
                  <div className="flex gap-3">
                    <button 
                      onClick={resetState}
                      className="px-4 py-2 border-2 border-gray-300 rounded-lg font-medium hover:bg-gray-50"
                    >
                      ‚Üê Start Over
                    </button>
                    <button 
                      onClick={addToDatabase}
                      disabled={selectedCount === 0}
                      className="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-6 py-2 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      Add to Database ‚Üí
                    </button>
                  </div>
                </div>
              </>
            )}
          </>
        )}

        {/* Database View */}
        {database.length > 0 && (
          <div className="mt-8 pt-6 border-t-2 border-gray-200">
            <div className="flex justify-between items-center mb-4 flex-wrap gap-2">
              <h3 className="font-bold text-lg text-gray-800">üìä Research Database ({database.length} firms)</h3>
              <div className="flex gap-2">
                {sheetsConfigured && (
                  <button 
                    onClick={pushToSheets}
                    disabled={loading}
                    className="text-sm bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium disabled:opacity-50"
                  >
                    {loading ? '...' : 'üì§ Push to Sheets'}
                  </button>
                )}
                <button 
                  onClick={exportDB}
                  className="text-sm border-2 border-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-50"
                >
                  üì• Export JSON
                </button>
              </div>
            </div>
            
            {database.map(d => (
              <div key={d.id} className="border-2 border-gray-200 rounded-lg p-4 mb-3">
                <div className="flex items-center gap-2 flex-wrap">
                  <span className="font-bold text-gray-800">{d.firm.name || d.firm.officialName}</span>
                  <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-bold">{d.firm.type || 'Unknown'}</span>
                </div>
                <div className="text-gray-500 text-sm mt-1">{d.firm.location} | {d.firm.aum || 'AUM Unknown'} | {d.contacts.length} contacts</div>
                <div className="mt-3 pt-3 border-t border-gray-100">
                  {d.contacts.map(c => (
                    <div key={c.id} className="flex items-center gap-2 text-sm py-1 flex-wrap">
                      <span className="font-medium text-gray-700">{c.name}</span>
                      <span className="text-gray-400">-</span>
                      <span className="text-gray-500">{c.title}</span>
                      {c.linkedin && <a href={c.linkedin} target="_blank" rel="noopener noreferrer" className="text-blue-500">üîó</a>}
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        )}

        {/* Debug Log */}
        <div className="mt-6 bg-gray-900 text-gray-300 rounded-lg p-4 text-xs font-mono max-h-32 overflow-y-auto">
          <div className="font-bold text-gray-400 mb-2">üêõ Debug Log</div>
          {debugLog.length === 0 && <div className="text-gray-600">Waiting for actions...</div>}
          {debugLog.map((l, i) => (
            <div key={i} className={l.type === 'error' ? 'text-red-400' : l.type === 'success' ? 'text-green-400' : 'text-blue-400'}>
              [{l.time}] {l.message}
            </div>
          ))}
        </div>
      </div>
      
      {/* Footer */}
      <div className="text-center text-white/70 text-sm mt-4">
        FourBridge Research Tool ‚Ä¢ Multi-Pass Discovery Engine
      </div>
    </div>
  );
}

// Render
ReactDOM.render(<FourBridgeResearch />, document.getElementById('root'));
    </script>
</body>
</html>
