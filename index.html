<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FourBridge Research</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 min-h-screen p-4">
  <div id="root"></div>
  
  <script type="text/babel">
    const App = () => {
      // State
      const [apiKey, setApiKey] = React.useState('');
      const [apiConfigured, setApiConfigured] = React.useState(false);
      const [sheetsUrl, setSheetsUrl] = React.useState('');
      const [sheetsConfigured, setSheetsConfigured] = React.useState(false);
      
      const [firmName, setFirmName] = React.useState('');
      const [location, setLocation] = React.useState('');
      const [loading, setLoading] = React.useState(false);
      const [error, setError] = React.useState('');
      const [statusMessage, setStatusMessage] = React.useState('');
      
      const [firm, setFirm] = React.useState(null);
      const [contacts, setContacts] = React.useState([]);
      const [database, setDatabase] = React.useState([]);
      const [logs, setLogs] = React.useState([]);

      // Load saved config
      React.useEffect(() => {
        try {
          const savedKey = localStorage.getItem('fourbridge_api_key');
          const savedSheets = localStorage.getItem('fourbridge_sheets_url');
          const savedDB = localStorage.getItem('fourbridge_database');
          if (savedKey) { setApiKey(savedKey); setApiConfigured(true); }
          if (savedSheets) { setSheetsUrl(savedSheets); setSheetsConfigured(true); }
          if (savedDB) { setDatabase(JSON.parse(savedDB)); }
        } catch {}
      }, []);

      // Save database
      React.useEffect(() => {
        try { localStorage.setItem('fourbridge_database', JSON.stringify(database)); } catch {}
      }, [database]);

      const log = (msg, type = 'info') => {
        const time = new Date().toLocaleTimeString();
        setLogs(prev => [...prev.slice(-20), { time, msg, type }]);
      };

      // ========== LEAN 2-PASS PROMPTS ==========
      
      // ========== ULTRA-LEAN PROMPTS ==========
      
      const PROMPTS = {
        // Pass 1: Firm + People (~60 tokens)
        discovery: (firm, loc) => `QUERY: "${firm}"${loc ? ` ${loc}` : ''}
TASK: firm info + 5-10 executives/partners/directors
JSON:{"firm":{name,type,location,aum,website},"people":[{name,title,source}]}`,

        // Pass 2: LinkedIn (~40 tokens per batch)
        linkedin: (firm, people) => `LINKEDIN SEARCH: site:linkedin.com/in "[name]"
${people.slice(0,6).map(p => `${p.name}|${p.title}`).join('\n')}
FIRM: ${firm}
JSON:[{name,linkedin}]`,

        // Deep Search: Individual (~20 tokens)
        linkedinSingle: (name, title, firm) => `site:linkedin.com/in "${name}" ${firm}
Return URL only or NOT_FOUND`
      };

      // ========== API CALLS ==========

      const callClaude = async (prompt, label) => {
        log(`${label}: Searching...`, 'info');
        setStatusMessage(`${label}...`);
        
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-3-5-haiku-20241022',
            max_tokens: 1024,
            tools: [{ type: 'web_search_20250305', name: 'web_search' }],
            messages: [{ role: 'user', content: prompt }]
          })
        });

        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        
        const data = await response.json();
        const text = data.content?.filter(b => b.type === 'text')?.map(b => b.text)?.join('\n') || '';
        log(`${label}: Complete`, 'success');
        return text;
      };

      const parseJSON = (text) => {
        // Strip markdown
        let cleaned = text.replace(/```json\s*/gi, '').replace(/```\s*/g, '').trim();
        
        // Try object
        const objMatch = cleaned.match(/\{[\s\S]*\}/);
        if (objMatch) {
          try { return JSON.parse(objMatch[0]); } catch {}
          // Fix common issues
          const fixed = objMatch[0].replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
          try { return JSON.parse(fixed); } catch {}
        }
        
        // Try array
        const arrMatch = cleaned.match(/\[[\s\S]*\]/);
        if (arrMatch) {
          try { return JSON.parse(arrMatch[0]); } catch {}
          const fixed = arrMatch[0].replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
          try { return JSON.parse(fixed); } catch {}
        }
        
        return null;
      };

      // ========== MAIN SEARCH FLOW ==========

      const searchFirm = async () => {
        if (!firmName.trim()) return;
        
        setLoading(true);
        setError('');
        setFirm(null);
        setContacts([]);
        setStatusMessage('Starting search...');
        
        try {
          // PASS 1: Discovery (firm + people)
          log(`Searching for: ${firmName}`, 'info');
          const pass1Response = await callClaude(
            PROMPTS.discovery(firmName, location),
            'Pass 1: Finding firm & people'
          );
          
          console.log('Pass 1 response:', pass1Response);
          const pass1Data = parseJSON(pass1Response);
          console.log('Pass 1 parsed:', pass1Data);
          
          if (!pass1Data) {
            throw new Error('Could not parse search results');
          }
          
          // Set firm info
          if (pass1Data.firm) {
            setFirm(pass1Data.firm);
            log(`Found: ${pass1Data.firm.name}`, 'success');
          }
          
          let people = pass1Data.people || [];
          log(`Found ${people.length} people`, people.length > 0 ? 'success' : 'info');
          
          // PASS 2: LinkedIn search (ALWAYS run if we have people)
          if (people.length > 0) {
            const pass2Response = await callClaude(
              PROMPTS.linkedin(pass1Data.firm?.name || firmName, people),
              'Pass 2: LinkedIn URLs'
            );
            
            console.log('Pass 2 response:', pass2Response);
            const linkedinData = parseJSON(pass2Response);
            console.log('Pass 2 parsed:', linkedinData);
            
            // Merge LinkedIn URLs into people
            if (Array.isArray(linkedinData)) {
              linkedinData.forEach(ld => {
                const person = people.find(p => 
                  p.name.toLowerCase().includes(ld.name?.toLowerCase()?.split(' ')[0]) ||
                  ld.name?.toLowerCase().includes(p.name?.toLowerCase()?.split(' ')[0])
                );
                if (person && ld.linkedin && ld.linkedin.includes('linkedin.com/in')) {
                  person.linkedin = ld.linkedin;
                }
              });
              log(`LinkedIn: Found ${linkedinData.filter(l => l.linkedin).length} URLs`, 'success');
            }
          }
          
          // Format contacts with proper confidence
          const formattedContacts = people.map((p, i) => ({
            id: `c${Date.now()}_${i}`,
            name: p.name,
            title: p.title,
            linkedin: p.linkedin || null,
            confidence: p.linkedin ? 'high' : 'low',
            source: p.source || 'Discovery',
            selected: !!p.linkedin, // Auto-select if has LinkedIn
            firm: pass1Data.firm?.name || firmName
          }));
          
          setContacts(formattedContacts);
          
          const withLinkedIn = formattedContacts.filter(c => c.linkedin).length;
          log(`Complete: ${formattedContacts.length} contacts, ${withLinkedIn} with LinkedIn`, 'success');
          setStatusMessage('');
          
        } catch (err) {
          log(`Error: ${err.message}`, 'error');
          setError(err.message);
          setStatusMessage('');
        } finally {
          setLoading(false);
        }
      };

      // ========== DEEP SEARCH (Optional 3rd pass) ==========
      
      const deepSearch = async () => {
        if (!firm) return;
        setLoading(true);
        setStatusMessage('Deep searching LinkedIn...');
        
        try {
          const missingLinkedIn = contacts.filter(c => !c.linkedin);
          if (missingLinkedIn.length === 0) {
            log('All contacts already have LinkedIn URLs!', 'success');
            setLoading(false);
            setStatusMessage('');
            return;
          }
          
          log(`Deep searching ${missingLinkedIn.length} people...`, 'info');
          
          // Search each person individually (more accurate)
          for (const contact of missingLinkedIn.slice(0, 5)) {
            setStatusMessage(`Searching: ${contact.name}...`);
            
            try {
              const response = await callClaude(
                PROMPTS.linkedinSingle(contact.name, contact.title, firm.name),
                `LinkedIn: ${contact.name}`
              );
              const urlMatch = response.match(/https:\/\/www\.linkedin\.com\/in\/[a-zA-Z0-9_-]+\/?/i);
              
              if (urlMatch) {
                setContacts(prev => prev.map(c => 
                  c.id === contact.id ? { ...c, linkedin: urlMatch[0], confidence: 'high' } : c
                ));
                log(`‚úì ${contact.name}`, 'success');
              } else {
                log(`‚úó ${contact.name}`, 'info');
              }
            } catch (err) {
              log(`Error: ${contact.name}`, 'error');
            }
          }
          
        } catch (err) {
          log(`Deep search error: ${err.message}`, 'error');
        } finally {
          setLoading(false);
          setStatusMessage('');
        }
      };

      // ========== DATABASE & EXPORT ==========

      const addToDatabase = () => {
        const selected = contacts.filter(c => c.selected);
        if (selected.length === 0) return;
        
        setDatabase(prev => [...prev, { firm, contacts: selected, addedAt: new Date().toISOString() }]);
        log(`Added ${selected.length} contacts to database`, 'success');
        
        // Reset for new search
        setFirm(null);
        setContacts([]);
        setFirmName('');
        setLocation('');
      };

      const pushToSheets = async () => {
        if (!sheetsUrl || database.length === 0) return;
        setLoading(true);
        
        try {
          const data = {
            exportedAt: new Date().toISOString(),
            firms: database.map(d => d.firm),
            prospects: database.flatMap(d => d.contacts)
          };
          
          await fetch(sheetsUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          log(`Pushed ${data.prospects.length} prospects to Sheets`, 'success');
          alert(`‚úÖ Pushed to Google Sheets!`);
        } catch (err) {
          log(`Push failed: ${err.message}`, 'error');
        } finally {
          setLoading(false);
        }
      };

      const exportDB = () => {
        const data = {
          exportedAt: new Date().toISOString(),
          firms: database.map(d => d.firm),
          prospects: database.flatMap(d => d.contacts)
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `fourbridge_research_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
      };

      const testApiKey = async () => {
        if (!apiKey.trim()) return;
        setLoading(true);
        try {
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: 'claude-3-5-haiku-20241022',
              max_tokens: 10,
              messages: [{ role: 'user', content: 'Say OK' }]
            })
          });
          if (response.ok) {
            setApiConfigured(true);
            localStorage.setItem('fourbridge_api_key', apiKey);
            log('API Connected!', 'success');
          } else {
            throw new Error(`${response.status}`);
          }
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const saveSheetsUrl = () => {
        if (sheetsUrl.includes('script.google.com')) {
          localStorage.setItem('fourbridge_sheets_url', sheetsUrl);
          setSheetsConfigured(true);
          log('Google Sheets connected', 'success');
        }
      };

      // ========== RENDER ==========

      return (
        <div className="max-w-2xl mx-auto">
          <div className="text-center mb-6">
            <h1 className="text-3xl font-bold text-white">üîç FourBridge Research</h1>
            <p className="text-white/80 text-sm">Ultra-Lean 2-Pass ‚Ä¢ ~$0.10/search</p>
          </div>

          <div className="bg-white rounded-2xl shadow-2xl p-6">
            {/* API Key Setup */}
            {!apiConfigured ? (
              <div className="mb-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2">Anthropic API Key</label>
                <div className="flex gap-2">
                  <input
                    type="password"
                    value={apiKey}
                    onChange={(e) => setApiKey(e.target.value)}
                    placeholder="sk-ant-..."
                    className="flex-1 p-3 border-2 border-gray-300 rounded-lg"
                  />
                  <button
                    onClick={testApiKey}
                    disabled={loading}
                    className="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 disabled:opacity-50"
                  >
                    {loading ? '...' : 'Connect'}
                  </button>
                </div>
              </div>
            ) : (
              <>
                <div className="bg-green-50 border-2 border-green-400 rounded-lg p-3 mb-4 flex justify-between items-center">
                  <span className="text-green-800 font-semibold">‚úÖ API Connected</span>
                  <button onClick={() => { setApiConfigured(false); setApiKey(''); localStorage.removeItem('fourbridge_api_key'); }} className="text-sm text-green-700">Change Key</button>
                </div>

                {/* Google Sheets */}
                {!sheetsConfigured ? (
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <p className="text-xs text-blue-600 mb-2">üìä Optional: Connect Google Sheets</p>
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={sheetsUrl}
                        onChange={(e) => setSheetsUrl(e.target.value)}
                        placeholder="https://script.google.com/macros/s/.../exec"
                        className="flex-1 p-2 border rounded text-sm"
                      />
                      <button onClick={saveSheetsUrl} className="bg-blue-600 text-white px-3 py-2 rounded text-sm">Save</button>
                    </div>
                  </div>
                ) : (
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-2 mb-4 flex justify-between items-center text-sm">
                    <span className="text-blue-800">üìä Sheets connected</span>
                    <button onClick={() => { setSheetsConfigured(false); localStorage.removeItem('fourbridge_sheets_url'); }} className="text-blue-600">Disconnect</button>
                  </div>
                )}

                {/* Search Form */}
                {!firm && contacts.length === 0 && (
                  <div>
                    <input
                      type="text"
                      value={firmName}
                      onChange={(e) => setFirmName(e.target.value)}
                      placeholder="Firm name (e.g., Rockefeller Capital Management)"
                      className="w-full p-3 border-2 border-purple-300 rounded-lg mb-3 focus:border-purple-500 focus:outline-none"
                      onKeyDown={(e) => e.key === 'Enter' && searchFirm()}
                    />
                    <input
                      type="text"
                      value={location}
                      onChange={(e) => setLocation(e.target.value)}
                      placeholder="Location (optional)"
                      className="w-full p-3 border-2 border-gray-300 rounded-lg mb-3"
                    />
                    <button
                      onClick={searchFirm}
                      disabled={loading || !firmName.trim()}
                      className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-lg font-bold text-lg hover:from-purple-700 hover:to-indigo-700 disabled:opacity-50"
                    >
                      {loading ? 'üîÑ Searching...' : 'Search ‚Üí'}
                    </button>
                  </div>
                )}

                {/* Status Message */}
                {statusMessage && (
                  <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-3 mb-4 text-center">
                    <span className="text-yellow-800 font-medium">‚è≥ {statusMessage}</span>
                  </div>
                )}

                {/* Error */}
                {error && (
                  <div className="bg-red-50 border border-red-300 rounded-lg p-3 mb-4 text-red-700">
                    ‚ùå {error}
                  </div>
                )}

                {/* Firm Info */}
                {firm && (
                  <div className="bg-gray-50 rounded-lg p-4 mb-4">
                    <div className="flex justify-between items-start">
                      <div>
                        <h3 className="font-bold text-lg text-gray-800">{firm.name}</h3>
                        <p className="text-sm text-gray-600">{firm.type} ‚Ä¢ {firm.location} ‚Ä¢ {firm.aum}</p>
                      </div>
                      <button
                        onClick={() => { setFirm(null); setContacts([]); }}
                        className="text-gray-400 hover:text-gray-600"
                      >‚úï</button>
                    </div>
                    {firm.website && (
                      <a href={firm.website} target="_blank" className="text-sm text-blue-600 hover:underline">{firm.website}</a>
                    )}
                  </div>
                )}

                {/* Contacts */}
                {contacts.length > 0 && (
                  <div>
                    <div className="flex justify-between items-center mb-3">
                      <h3 className="font-bold text-gray-800">üë• Contacts ({contacts.length})</h3>
                      <button
                        onClick={deepSearch}
                        disabled={loading}
                        className="text-sm bg-purple-100 text-purple-700 px-3 py-1 rounded hover:bg-purple-200 disabled:opacity-50"
                      >
                        üîç Deep Search LinkedIn
                      </button>
                    </div>
                    
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                      {contacts.map(contact => (
                        <div
                          key={contact.id}
                          className={`border-2 rounded-lg p-3 transition-all ${contact.selected ? 'border-green-400 bg-green-50' : 'border-gray-200'}`}
                        >
                          <div className="flex items-start gap-3">
                            <input
                              type="checkbox"
                              checked={contact.selected}
                              onChange={() => setContacts(prev => prev.map(c => c.id === contact.id ? { ...c, selected: !c.selected } : c))}
                              className="mt-1 w-5 h-5"
                            />
                            <div className="flex-1">
                              <div className="flex items-center gap-2">
                                <span className="font-semibold">{contact.name}</span>
                                <span className={`text-xs px-2 py-0.5 rounded ${
                                  contact.confidence === 'high' ? 'bg-green-200 text-green-800' :
                                  contact.confidence === 'medium' ? 'bg-yellow-200 text-yellow-800' :
                                  'bg-gray-200 text-gray-600'
                                }`}>{contact.confidence}</span>
                              </div>
                              <p className="text-sm text-gray-600">{contact.title}</p>
                              {contact.linkedin ? (
                                <a href={contact.linkedin} target="_blank" className="text-xs text-blue-600 hover:underline">üîó {contact.linkedin}</a>
                              ) : (
                                <span className="text-xs text-red-500">No LinkedIn found</span>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>

                    <div className="mt-4 flex gap-2">
                      <button
                        onClick={addToDatabase}
                        disabled={contacts.filter(c => c.selected).length === 0}
                        className="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 disabled:opacity-50"
                      >
                        ‚úì Add {contacts.filter(c => c.selected).length} to Database
                      </button>
                      <button
                        onClick={() => { setFirm(null); setContacts([]); }}
                        className="px-4 py-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50"
                      >
                        Skip
                      </button>
                    </div>
                  </div>
                )}

                {/* Database */}
                {database.length > 0 && !firm && contacts.length === 0 && (
                  <div className="mt-6 pt-6 border-t">
                    <div className="flex justify-between items-center mb-3">
                      <h3 className="font-bold text-gray-800">üìä Database ({database.length} firms)</h3>
                      <div className="flex gap-2">
                        {sheetsConfigured && (
                          <button onClick={pushToSheets} disabled={loading} className="text-sm bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">
                            üì§ Push to Sheets
                          </button>
                        )}
                        <button onClick={exportDB} className="text-sm border border-gray-300 px-3 py-1 rounded hover:bg-gray-50">
                          üì• Export JSON
                        </button>
                      </div>
                    </div>
                    <div className="space-y-2">
                      {database.map((entry, i) => (
                        <div key={i} className="bg-gray-50 rounded p-3">
                          <div className="flex justify-between">
                            <span className="font-medium">{entry.firm?.name || 'Unknown'}</span>
                            <span className="text-sm text-gray-500">{entry.contacts.length} contacts</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </>
            )}

            {/* Debug Log */}
            <div className="mt-6 bg-gray-900 rounded-lg p-3 text-xs font-mono max-h-40 overflow-y-auto">
              <div className="text-gray-400 mb-1">üìã Log</div>
              {logs.map((l, i) => (
                <div key={i} className={l.type === 'error' ? 'text-red-400' : l.type === 'success' ? 'text-green-400' : 'text-blue-400'}>
                  [{l.time}] {l.msg}
                </div>
              ))}
            </div>
          </div>

          <div className="text-center mt-4 text-white/60 text-xs">
            FourBridge Research ‚Ä¢ Ultra-Lean Engine
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
