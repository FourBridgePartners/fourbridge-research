<!DOCTYPE html>
<html lang="en">
<!-- FourBridge v8.0 - Optimized: Knowledge firm search + 2-4 targeted web searches = ~$0.055 -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FourBridge v8</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root { --bg: #09090b; --card: #18181b; --border: #27272a; --text: #fafafa; --dim: #a1a1aa; --accent: #3b82f6; --success: #22c55e; --warning: #f59e0b; --error: #ef4444; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; min-height: 100vh; }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { font-size: 18px; font-weight: 600; }
    .subtitle { color: var(--dim); font-size: 11px; margin-bottom: 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px; }
    label { display: block; font-size: 10px; color: var(--dim); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    input { width: 100%; padding: 8px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 13px; }
    input:focus { outline: none; border-color: var(--accent); }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border: none; border-radius: 4px; font-size: 12px; font-weight: 500; cursor: pointer; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover:not(:disabled) { background: #2563eb; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { background: var(--border); color: var(--text); }
    .btn-success { background: var(--success); color: white; }
    .btn-small { padding: 4px 8px; font-size: 11px; }
    .status { padding: 8px 12px; border-radius: 4px; margin-bottom: 10px; font-size: 12px; display: flex; align-items: center; gap: 8px; }
    .status.loading { background: rgba(59,130,246,0.1); border: 1px solid var(--accent); }
    .status.success { background: rgba(34,197,94,0.1); border: 1px solid var(--success); }
    .status.error { background: rgba(239,68,68,0.1); border: 1px solid var(--error); }
    .spinner { width: 12px; height: 12px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .cost { display: inline-block; padding: 2px 6px; background: rgba(34,197,94,0.15); color: var(--success); border-radius: 3px; font-size: 10px; font-family: monospace; }
    .steps { display: flex; gap: 4px; margin-bottom: 16px; }
    .step { padding: 6px 12px; border-radius: 4px; font-size: 11px; background: var(--border); color: var(--dim); }
    .step.active { background: var(--accent); color: white; }
    .step.done { background: var(--success); color: white; }
    .firm-option { padding: 12px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.15s; }
    .firm-option:hover { border-color: var(--accent); background: rgba(59,130,246,0.05); }
    .firm-option h4 { font-size: 13px; margin-bottom: 2px; }
    .firm-option .meta { font-size: 11px; color: var(--dim); }
    .firm-option .badge { display: inline-block; padding: 1px 6px; background: rgba(59,130,246,0.2); color: var(--accent); border-radius: 3px; font-size: 9px; margin-right: 6px; }
    .selected-firm { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 6px; margin-bottom: 12px; }
    .selected-firm h4 { font-size: 13px; color: var(--success); }
    .selected-firm .meta { font-size: 11px; color: var(--dim); }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th { text-align: left; padding: 6px 8px; font-size: 10px; text-transform: uppercase; color: var(--dim); border-bottom: 1px solid var(--border); }
    td { padding: 4px 6px; border-bottom: 1px solid var(--border); }
    .edit-input { background: transparent; border: 1px solid transparent; padding: 6px; color: var(--text); font-size: 12px; width: 100%; border-radius: 3px; }
    .edit-input:hover { border-color: var(--border); }
    .edit-input:focus { outline: none; border-color: var(--accent); background: var(--bg); }
    .del-btn { background: none; border: none; color: #52525b; cursor: pointer; padding: 4px; font-size: 14px; }
    .del-btn:hover { color: var(--error); }
    .add-row { padding: 8px; color: var(--dim); cursor: pointer; font-size: 12px; }
    .add-row:hover { background: rgba(255,255,255,0.03); }
    .actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); flex-wrap: wrap; }
    .db-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .db-header h2 { font-size: 13px; color: var(--dim); }
    .empty { text-align: center; padding: 20px; color: var(--dim); font-size: 12px; }
    .search-row { display: flex; gap: 8px; }
    .search-row input { flex: 1; }
    .api-row { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
    .api-row input { flex: 1; }
    .dot { width: 6px; height: 6px; border-radius: 50%; }
    .dot.on { background: var(--success); }
    .dot.off { background: var(--error); }
    .tip { font-size: 10px; color: var(--dim); margin-top: 6px; padding: 6px; background: rgba(255,255,255,0.02); border-radius: 4px; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    function App() {
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('fb8_key') || '');
      const [query, setQuery] = useState('');
      const [loading, setLoading] = useState(false);
      const [status, setStatus] = useState(null);
      const [cost, setCost] = useState(0);
      
      const [step, setStep] = useState(1);
      const [firmOptions, setFirmOptions] = useState([]);
      const [selectedFirm, setSelectedFirm] = useState(null);
      const [people, setPeople] = useState([]);
      
      const [db, setDb] = useState(() => {
        try { return JSON.parse(localStorage.getItem('fb8_db')) || { prospects: [] }; }
        catch { return { prospects: [] }; }
      });
      
      useEffect(() => { if(apiKey) localStorage.setItem('fb8_key', apiKey); }, [apiKey]);
      useEffect(() => { localStorage.setItem('fb8_db', JSON.stringify(db)); }, [db]);
      
      // ============================================================
      // PARSE JSON (bulletproof)
      // ============================================================
      const parseJSON = (text) => {
        let s = text.replace(/```json\s*/gi, '').replace(/```/g, '').trim();
        
        const objStart = s.indexOf('{');
        const arrStart = s.indexOf('[');
        
        let start, endChar;
        if (arrStart !== -1 && (objStart === -1 || arrStart < objStart)) {
          start = arrStart; endChar = ']';
        } else if (objStart !== -1) {
          start = objStart; endChar = '}';
        } else return null;
        
        let depth = 0, inStr = false, esc = false, end = -1;
        const openChar = endChar === ']' ? '[' : '{';
        for (let i = start; i < s.length; i++) {
          const c = s[i];
          if (esc) { esc = false; continue; }
          if (c === '\\') { esc = true; continue; }
          if (c === '"') { inStr = !inStr; continue; }
          if (!inStr) {
            if (c === openChar) depth++;
            if (c === endChar) { depth--; if (depth === 0) { end = i; break; } }
          }
        }
        if (end === -1) return null;
        
        let json = s.substring(start, end + 1);
        try { return JSON.parse(json); } catch {}
        
        // Repair common issues
        json = json.replace(/,\s*[\}\]]/g, m => m.slice(-1));
        json = json.replace(/":\s*\n\s*([^",\{\[\]]+?)([,\}\]])/g, '": "$1"$2');
        try { return JSON.parse(json); } catch {}
        
        // Manual extraction for arrays
        const items = [];
        const itemRegex = /\{[^{}]*"name"\s*:\s*"([^"]+)"[^{}]*\}/g;
        let match;
        while ((match = itemRegex.exec(s)) !== null) {
          const obj = match[0];
          items.push({
            name: obj.match(/"name"\s*:\s*"([^"]+)"/)?.[1] || '',
            title: obj.match(/"title"\s*:\s*"([^"]+)"/)?.[1] || '',
            linkedin: obj.match(/"linkedin"\s*:\s*"(https?:\/\/[^"]+)"/)?.[1] || null,
            type: obj.match(/"type"\s*:\s*"([^"]+)"/)?.[1] || '',
            location: obj.match(/"location"\s*:\s*"([^"]+)"/)?.[1] || '',
            aum: obj.match(/"aum"\s*:\s*"([^"]+)"/)?.[1] || '',
            description: obj.match(/"description"\s*:\s*"([^"]+)"/)?.[1] || ''
          });
        }
        return items.length > 0 ? items : null;
      };
      
      // ============================================================
      // STEP 1: FIRM SEARCH (Knowledge only - NO web search - $0.002)
      // ============================================================
      const searchFirms = async () => {
        if (!apiKey || !query.trim()) return;
        
        setLoading(true);
        setStatus({ msg: 'Finding organizations...', type: 'loading' });
        setFirmOptions([]);
        setSelectedFirm(null);
        setPeople([]);
        setCost(0);
        
        try {
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-api-key": apiKey,
              "anthropic-version": "2023-06-01",
              "anthropic-dangerous-direct-browser-access": "true"
            },
            body: JSON.stringify({
              model: "claude-3-5-haiku-20241022",
              max_tokens: 1500,
              messages: [{ 
                role: "user", 
                content: `List investment organizations matching "${query}".

Include: family offices, foundations, endowments, RIAs, wealth managers.

Return JSON array (3-6 options):
[
  {"name": "Full Official Name", "type": "SFO/MFO/Foundation/Endowment/RIA", "location": "City, State", "aum": "$X billion", "description": "One sentence"}
]

JSON only, no other text.`
              }]
            })
          });
          
          if (!response.ok) throw new Error((await response.json()).error?.message || 'API Error');
          
          const data = await response.json();
          const tokenCost = (data.usage?.input_tokens || 0) * 0.00000025 + 
                           (data.usage?.output_tokens || 0) * 0.00000125;
          setCost(tokenCost);
          
          console.log(`=== STEP 1 (knowledge): $${tokenCost.toFixed(5)} ===`);
          
          const text = data.content?.[0]?.text || '';
          const parsed = parseJSON(text);
          const firms = Array.isArray(parsed) ? parsed : parsed?.firms || [];
          
          if (firms.length > 0) {
            setFirmOptions(firms.filter(f => f.name));
            setStep(2);
            setStatus({ msg: `Found ${firms.length} organizations`, type: 'success' });
          } else {
            setStatus({ msg: 'No organizations found. Try different terms.', type: 'error' });
          }
        } catch (err) {
          console.error(err);
          setStatus({ msg: err.message, type: 'error' });
        } finally {
          setLoading(false);
        }
      };
      
      // ============================================================
      // STEP 2: SELECT FIRM ‚Üí GET PEOPLE + LINKEDIN 
      // Uses the PROVEN search pattern from testing:
      // 1. General search for all names
      // 2. LinkedIn searches with firm context
      // ============================================================
      const selectFirm = async (firm) => {
        setSelectedFirm(firm);
        setLoading(true);
        setStatus({ msg: `Researching ${firm.name}...`, type: 'loading' });
        setPeople([]);
        setStep(3);
        
        try {
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-api-key": apiKey,
              "anthropic-version": "2023-06-01",
              "anthropic-dangerous-direct-browser-access": "true",
              "anthropic-beta": "token-efficient-tools-2025-02-19"
            },
            body: JSON.stringify({
              model: "claude-3-5-haiku-20241022",
              max_tokens: 4000,
              tools: [{ type: "web_search_20250305", name: "web_search" }],
              messages: [{ 
                role: "user", 
                content: `Find all leadership and their LinkedIn profiles for: ${firm.name}

FOLLOW THIS EXACT SEARCH PATTERN:

SEARCH 1 - Get all names:
Search: "${firm.name} leadership team executives"
This will return results from TheOrg, RocketReach, company website, news articles.
Extract EVERY person mentioned: CEO, CFO, CIO, COO, Partners, Managing Directors, Board members.

SEARCH 2 - Get LinkedIn profiles:
For each person found, search: site:linkedin.com/in [FirstName] [LastName] ${firm.name}

IMPORTANT: Include "${firm.name}" in the LinkedIn search query. This:
- Returns the correct person (not someone else with same name)
- Often returns MULTIPLE people from the firm in one search
- Provides verification in the search snippet

VERIFICATION:
The search snippet will show their role. Example:
"James Brace, CFA - COO at GLASfunds" ‚Üê This confirms it's the right person
Only include LinkedIn URLs where the snippet confirms they work at ${firm.name}.

OUTPUT FORMAT:
Return a JSON array of ALL people found:
[
  {"name": "Full Name", "title": "Their Title", "linkedin": "https://linkedin.com/in/exact-url-from-search"},
  {"name": "Another Person", "title": "Title", "linkedin": "https://linkedin.com/in/their-url"},
  {"name": "Person Without LinkedIn", "title": "Title", "linkedin": null}
]

Return ONLY the JSON array. Find as many people as possible (aim for 5-15).`
              }]
            })
          });
          
          if (!response.ok) throw new Error((await response.json()).error?.message || 'API Error');
          
          const data = await response.json();
          const tokenCost = (data.usage?.input_tokens || 0) * 0.00000025 + 
                           (data.usage?.output_tokens || 0) * 0.00000125;
          const totalCost = tokenCost + 0.05;
          setCost(prev => prev + totalCost);
          
          console.log(`=== STEP 2 (web search): $${totalCost.toFixed(4)} ===`);
          
          const text = data.content?.filter(c => c.type === 'text').map(c => c.text).join('\n') || '';
          console.log("=== RAW RESPONSE ===\n", text);
          
          const parsed = parseJSON(text);
          console.log("=== PARSED ===", parsed);
          
          const peopleList = Array.isArray(parsed) ? parsed : parsed?.people || [];
          
          if (peopleList.length > 0) {
            const ppl = peopleList.map((p, i) => ({
              id: `${Date.now()}_${i}`,
              name: p.name || '',
              title: p.title || '',
              linkedin: (p.linkedin && p.linkedin !== 'null' && p.linkedin.includes('linkedin')) ? p.linkedin : ''
            }));
            setPeople(ppl);
            
            const withLI = ppl.filter(p => p.linkedin).length;
            setStatus({ msg: `Found ${ppl.length} people, ${withLI} with verified LinkedIn`, type: 'success' });
          } else {
            setStatus({ msg: 'No people found. Add manually below.', type: 'error' });
            setPeople([{ id: Date.now().toString(), name: '', title: '', linkedin: '' }]);
          }
        } catch (err) {
          console.error(err);
          setStatus({ msg: err.message, type: 'error' });
        } finally {
          setLoading(false);
        }
      };
      
      // Edit helpers
      const updatePerson = (id, field, value) => setPeople(p => p.map(x => x.id === id ? {...x, [field]: value} : x));
      const deletePerson = (id) => setPeople(p => p.filter(x => x.id !== id));
      const addPerson = () => setPeople(p => [...p, { id: Date.now().toString(), name: '', title: '', linkedin: '' }]);
      
      // Save to DB
      const saveToDb = () => {
        if (!selectedFirm) return;
        const newProspects = people.filter(p => p.name.trim()).map(p => ({
          id: p.id, name: p.name, title: p.title, firm: selectedFirm.name,
          firmType: selectedFirm.type, firmLocation: selectedFirm.location,
          linkedin: p.linkedin || null, addedAt: new Date().toISOString()
        }));
        const existing = new Set(db.prospects.map(p => `${p.name}|${p.firm}`.toLowerCase()));
        const unique = newProspects.filter(p => !existing.has(`${p.name}|${p.firm}`.toLowerCase()));
        setDb(prev => ({ prospects: [...prev.prospects, ...unique] }));
        setStatus({ msg: `Saved ${unique.length} prospects`, type: 'success' });
      };
      
      // Reset
      const reset = () => {
        setStep(1); setFirmOptions([]); setSelectedFirm(null); setPeople([]);
        setQuery(''); setCost(0); setStatus(null);
      };
      
      // Export
      const exportDb = () => {
        const blob = new Blob([JSON.stringify(db, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `fourbridge_${new Date().toISOString().split('T')[0]}.json`; a.click();
      };
      
      return (
        <div className="container">
          <h1>üéØ FourBridge Research</h1>
          <p className="subtitle">v8.0 ‚Ä¢ Knowledge + targeted web search = <span className="cost">~$0.055 total</span></p>
          
          <div className="steps">
            <div className={`step ${step === 1 ? 'active' : step > 1 ? 'done' : ''}`}>1. Search</div>
            <div className={`step ${step === 2 ? 'active' : step > 2 ? 'done' : ''}`}>2. Select</div>
            <div className={`step ${step === 3 ? 'active' : ''}`}>3. Contacts</div>
          </div>
          
          <div className="card">
            <div className="api-row">
              <span className={`dot ${apiKey ? 'on' : 'off'}`}></span>
              <input type="password" placeholder="Anthropic API Key" value={apiKey} onChange={e => setApiKey(e.target.value)} />
            </div>
            
            {step === 1 && (
              <>
                <label>Search Organization</label>
                <div className="search-row">
                  <input
                    placeholder="Rockefeller, GLASfunds, Zenfinity, Harris..."
                    value={query}
                    onChange={e => setQuery(e.target.value)}
                    onKeyDown={e => e.key === 'Enter' && searchFirms()}
                  />
                  <button className="btn btn-primary" onClick={searchFirms} disabled={!apiKey || !query.trim() || loading}>
                    {loading ? <span className="spinner"></span> : 'üîç Search'}
                  </button>
                </div>
                <div className="tip">Step 1 uses Claude's knowledge (no web search) = ~$0.002</div>
              </>
            )}
            
            {step === 2 && !selectedFirm && (
              <>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>
                  <label style={{ margin: 0 }}>Select Organization</label>
                  <button className="btn btn-small btn-secondary" onClick={reset}>‚Üê Back</button>
                </div>
                {firmOptions.map((f, i) => (
                  <div key={i} className="firm-option" onClick={() => !loading && selectFirm(f)}>
                    <h4>{f.name}</h4>
                    <div className="meta">
                      {f.type && <span className="badge">{f.type}</span>}
                      {f.location} {f.aum && f.aum !== 'unknown' && ` ‚Ä¢ ${f.aum}`}
                    </div>
                    {f.description && <div className="meta" style={{marginTop:4}}>{f.description}</div>}
                  </div>
                ))}
                <div className="tip">Selecting triggers ONE web search for all people + LinkedIn = ~$0.05</div>
              </>
            )}
            
            {selectedFirm && (
              <div className="selected-firm">
                <div>
                  <h4>‚úì {selectedFirm.name}</h4>
                  <div className="meta">{selectedFirm.type} ‚Ä¢ {selectedFirm.location}</div>
                </div>
                <button className="btn btn-small btn-secondary" onClick={reset}>Change</button>
              </div>
            )}
            
            {cost > 0 && <div style={{textAlign:'right',marginTop:8}}><span className="cost">${cost.toFixed(4)}</span></div>}
          </div>
          
          {status && (
            <div className={`status ${status.type}`}>
              {status.type === 'loading' && <span className="spinner"></span>}
              {status.msg}
            </div>
          )}
          
          {people.length > 0 && (
            <div className="card">
              <table>
                <thead>
                  <tr>
                    <th style={{width:'25%'}}>Name</th>
                    <th style={{width:'25%'}}>Title</th>
                    <th style={{width:'40%'}}>LinkedIn</th>
                    <th style={{width:'10%'}}></th>
                  </tr>
                </thead>
                <tbody>
                  {people.map(p => (
                    <tr key={p.id}>
                      <td><input className="edit-input" value={p.name} onChange={e => updatePerson(p.id,'name',e.target.value)} placeholder="Name"/></td>
                      <td><input className="edit-input" value={p.title} onChange={e => updatePerson(p.id,'title',e.target.value)} placeholder="Title"/></td>
                      <td><input className="edit-input" value={p.linkedin} onChange={e => updatePerson(p.id,'linkedin',e.target.value)} placeholder="LinkedIn URL" style={{color: p.linkedin ? 'var(--success)' : 'var(--dim)'}}/></td>
                      <td><button className="del-btn" onClick={() => deletePerson(p.id)}>√ó</button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <div className="add-row" onClick={addPerson}>+ Add person</div>
              <div className="actions">
                <button className="btn btn-success" onClick={saveToDb}>üíæ Save {people.filter(p=>p.name.trim()).length} to Database</button>
                <span style={{marginLeft:'auto',fontSize:11,color:'var(--dim)'}}>{people.filter(p=>p.linkedin).length}/{people.length} with LinkedIn</span>
              </div>
            </div>
          )}
          
          <div style={{marginTop:20}}>
            <div className="db-header">
              <h2>üìÅ Database ({db.prospects.length})</h2>
              <div style={{display:'flex',gap:8}}>
                <button className="btn btn-small btn-secondary" onClick={exportDb}>Export</button>
                <button className="btn btn-small btn-secondary" onClick={() => {if(confirm('Clear?')) setDb({prospects:[]})}}>Clear</button>
              </div>
            </div>
            {db.prospects.length > 0 ? (
              <div className="card" style={{padding:0}}>
                <table>
                  <thead><tr><th>Name</th><th>Title</th><th>Firm</th><th>LinkedIn</th></tr></thead>
                  <tbody>
                    {db.prospects.slice(-10).reverse().map(p => (
                      <tr key={p.id}>
                        <td style={{padding:8,fontWeight:500}}>{p.name}</td>
                        <td style={{padding:8,color:'var(--dim)'}}>{p.title}</td>
                        <td style={{padding:8}}>{p.firm}</td>
                        <td style={{padding:8}}>{p.linkedin ? <a href={p.linkedin} target="_blank" style={{color:'var(--accent)',fontSize:11}}>View‚Üí</a> : '‚Äî'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            ) : <div className="card empty">No prospects yet</div>}
          </div>
        </div>
      );
    }
    
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
